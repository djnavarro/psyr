<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>manipulating-data.utf8</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<!-- ###### start inserted header ##### -->

<!-- add plausible.io -->
<script async defer data-domain="psyr.djnavarro.net" src="https://plausible.io/js/plausible.js"></script>

<!-- add fontawesome -->
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">

<!-- add the twitter card and open graph tags -->
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@djnavarro">
<meta property="og:url" content="https://psyr.org">
<meta property="og:title" content="R for Psychological Science">
<meta property="og:description" content="An introductory resource">
<meta property="og:image" content="http://psyr.org/img/splash_turtle.png">

<!-- ###### end inserted header ##### -->

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>





<link rel="stylesheet" href="mystyle.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-sm-12 col-md-4 col-lg-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-sm-12 col-md-8 col-lg-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">R for Psychological Science</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Core
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="getting-started.html">Getting started</a>
    </li>
    <li>
      <a href="variables.html">Variables</a>
    </li>
    <li>
      <a href="scripts.html">Scripts</a>
    </li>
    <li>
      <a href="packages.html">Packages</a>
    </li>
    <li>
      <a href="workspaces.html">Workspaces</a>
    </li>
    <li>
      <a href="vectors.html">Vectors</a>
    </li>
    <li>
      <a href="loops.html">Loops</a>
    </li>
    <li>
      <a href="branches.html">Branches</a>
    </li>
    <li>
      <a href="functions.html">Functions</a>
    </li>
    <li>
      <a href="programming.html">Programming</a>
    </li>
    <li>
      <a href="file-system.html">File system</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Data
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="prelude-to-data.html">Prelude</a>
    </li>
    <li>
      <a href="data-types.html">Data types</a>
    </li>
    <li>
      <a href="describing-data.html">Describing data</a>
    </li>
    <li>
      <a href="visualising-data.html">Visualising data</a>
    </li>
    <li>
      <a href="manipulating-data.html">Manipulating data</a>
    </li>
    <li>
      <a href="working-with-text.html">Text data</a>
    </li>
    <li>
      <a href="import-export.html">Import/export</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Stats
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="probability.html">Probability distributions</a>
    </li>
    <li>
      <a href="introductory-statistics.html">Introductory statistics</a>
    </li>
    <li>
      <a href="intermediate-statistics.html">Intermediate statistics</a>
    </li>
    <li>
      <a href="advanced-statistics.html">Advanced statistics</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    More
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="experiments.html">Experiments</a>
    </li>
    <li>
      <a href="shiny.html">Shiny apps</a>
    </li>
    <li>
      <a href="web-scraping.html">Web scraping</a>
    </li>
    <li>
      <a href="xx-miscellaneous.html">Miscellaneous</a>
    </li>
    <li>
      <a href="backprop.html">Backpropagation networks</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://compcogscisydney.org">compcogscisydney.org</a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">




</div>


<style type="text/css">
h1{
  line-height: 100px;
}
h2{
  line-height: 80px;
}
h3{
  line-height: 60px;
}
</style>
<p>Data manipulation isn’t a particularly well defined topic. I take it to cover a few topics:</p>
<ul>
<li>Importing and exporting data</li>
<li>Cleaning up errors in data</li>
<li>Reorganising data</li>
</ul>
<p>Earlier sections of the notes covered variations of this:</p>
<ul>
<li>Reading and writing from CSV files and .RData files</li>
<li>Creating data frames, tibbles and factors from other input</li>
<li>Using filter and select to extract subsets of a data frame</li>
<li>Using mutate to create or alter columns in a data frame</li>
<li>Using arrange to sort a data frame</li>
</ul>
<div id="an-illustrative-problem" class="section level2">
<h2><span class="header-section-number">16.1</span> An illustrative problem</h2>
<p>In the <a href="./visualising-data.html">data visualisation</a> we used a data set looking at inductive reasoning stored in the <a href="./data/frames_ex2.csv">frames_ex2.csv</a> file. Here it is again:</p>
<pre class="r"><code>frames &lt;- read_csv(&quot;./data/frames_ex2.csv&quot;)
frames</code></pre>
<pre><code>## # A tibble: 4,725 x 8
##       id gender   age condition sample_size n_obs test_item
##    &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;chr&gt;     &lt;chr&gt;       &lt;dbl&gt;     &lt;dbl&gt;
##  1     1 male      36 category  small           2         1
##  2     1 male      36 category  small           2         2
##  3     1 male      36 category  small           2         3
##  4     1 male      36 category  small           2         4
##  5     1 male      36 category  small           2         5
##  6     1 male      36 category  small           2         6
##  7     1 male      36 category  small           2         7
##  8     1 male      36 category  medium          6         1
##  9     1 male      36 category  medium          6         2
## 10     1 male      36 category  medium          6         3
## # … with 4,715 more rows, and 1 more variable: response &lt;dbl&gt;</code></pre>
<p>In this file the data are stored in <em>long form</em>, in which there is one row for every trial in the experiment and thus the data from each participant are spread across several rows. I stored the data in that format because it was handy for drawing pictures, but as it happen this isn’t how the data set was stored when I extracted it from the <a href="https://osf.io/j4dxm/">OSF repository</a> in which I’d deposited it only a few months earlier! Here’s what it looked like when I found it:</p>
<pre class="r"><code>wide_frames &lt;- read_csv(&quot;./data/frames_ex2_wide.csv&quot;)
wide_frames</code></pre>
<pre><code>## # A tibble: 225 x 25
##       ID Gender   Age Sampling `SS2-R1` `SS2-R2` `SS2-R3`
##    &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;chr&gt;       &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
##  1     1 male      36 category        8        7        6
##  2     2 male      46 category        7        5        5
##  3     3 female    33 property        8        7        7
##  4     4 female    71 property        6        7        6
##  5     5 female    23 property        9        9        9
##  6     6 female    31 category        7        7        7
##  7     7 male      23 property        6        7        5
##  8     8 female    31 property        4        4        2
##  9     9 female    37 category        9        9        7
## 10    10 female    46 category        8        6        4
## # … with 215 more rows, and 18 more variables: SS2-R4 &lt;dbl&gt;,
## #   SS2-R5 &lt;dbl&gt;, SS2-R6 &lt;dbl&gt;, SS2-R7 &lt;dbl&gt;, SS6-R1 &lt;dbl&gt;,
## #   SS6-R2 &lt;dbl&gt;, SS6-R3 &lt;dbl&gt;, SS6-R4 &lt;dbl&gt;, SS6-R5 &lt;dbl&gt;,
## #   SS6-R6 &lt;dbl&gt;, SS6-R7 &lt;dbl&gt;, SS12-R1 &lt;dbl&gt;, SS12-R2 &lt;dbl&gt;,
## #   SS12-R3 &lt;dbl&gt;, SS12-R4 &lt;dbl&gt;, SS12-R5 &lt;dbl&gt;, SS12-R6 &lt;dbl&gt;,
## #   SS12-R7 &lt;dbl&gt;</code></pre>
<p>In this file, the data are stored in <em>wide form</em>. The data frame contains only one row per person, and each judgment they make is stored as a separate variable. Wide and long form data are useful for a number of purposes. How do we switch between them, “reshaping” the data to the form we need?</p>
<p>Once upon a time this used to be a difficult task, so much so that I wrote my own (not very good) functions that would solve this problem in a way that didn’t expose my students to some of the more frustrating aspects of data manipulation. Thankfully, this has changed. There is a little package distributed with the tidyverse called <strong>tidyr</strong> and it is remarkably effective at solving a range of reshaping problems in a (fairly) intuitive way.</p>
</div>
<div id="reshaping-a-data-frame" class="section level2">
<h2><span class="header-section-number">16.2</span> Reshaping a data frame</h2>
<pre class="r"><code>long_frames &lt;- wide_frames %&gt;% 
  gather(key = &quot;query&quot;, value=&quot;response&quot;,
         &quot;SS2-R1&quot;, &quot;SS2-R2&quot;,&quot;SS2-R3&quot;,&quot;SS2-R4&quot;,&quot;SS2-R5&quot;,&quot;SS2-R6&quot;,&quot;SS2-R7&quot;,
         &quot;SS6-R1&quot;,&quot;SS6-R2&quot;,&quot;SS6-R3&quot;,&quot;SS6-R4&quot;,&quot;SS6-R5&quot;,&quot;SS6-R6&quot;,&quot;SS6-R7&quot;, 
         &quot;SS12-R1&quot;,&quot;SS12-R2&quot;,&quot;SS12-R3&quot;,&quot;SS12-R4&quot;,&quot;SS12-R5&quot;,&quot;SS12-R6&quot;,&quot;SS12-R7&quot;)
long_frames</code></pre>
<pre><code>## # A tibble: 4,725 x 6
##       ID Gender   Age Sampling query  response
##    &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;chr&gt;    &lt;chr&gt;     &lt;dbl&gt;
##  1     1 male      36 category SS2-R1        8
##  2     2 male      46 category SS2-R1        7
##  3     3 female    33 property SS2-R1        8
##  4     4 female    71 property SS2-R1        6
##  5     5 female    23 property SS2-R1        9
##  6     6 female    31 category SS2-R1        7
##  7     7 male      23 property SS2-R1        6
##  8     8 female    31 property SS2-R1        4
##  9     9 female    37 category SS2-R1        9
## 10    10 female    46 category SS2-R1        8
## # … with 4,715 more rows</code></pre>
<p>To go back the other way, we could do this:</p>
<pre class="r"><code>long_frames %&gt;% spread(key = &quot;query&quot;, value = &quot;response&quot;)</code></pre>
<pre><code>## # A tibble: 225 x 25
##       ID Gender   Age Sampling `SS12-R1` `SS12-R2` `SS12-R3`
##    &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;chr&gt;        &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
##  1     1 male      36 category         8         7         6
##  2     2 male      46 category         9         9         8
##  3     3 female    33 property         8         9         9
##  4     4 female    71 property         9         8         3
##  5     5 female    23 property         9         9         9
##  6     6 female    31 category         9         9         8
##  7     7 male      23 property         8         7         6
##  8     8 female    31 property         8         8         7
##  9     9 female    37 category         9         8         1
## 10    10 female    46 category         9         9         8
## # … with 215 more rows, and 18 more variables: SS12-R4 &lt;dbl&gt;,
## #   SS12-R5 &lt;dbl&gt;, SS12-R6 &lt;dbl&gt;, SS12-R7 &lt;dbl&gt;, SS2-R1 &lt;dbl&gt;,
## #   SS2-R2 &lt;dbl&gt;, SS2-R3 &lt;dbl&gt;, SS2-R4 &lt;dbl&gt;, SS2-R5 &lt;dbl&gt;,
## #   SS2-R6 &lt;dbl&gt;, SS2-R7 &lt;dbl&gt;, SS6-R1 &lt;dbl&gt;, SS6-R2 &lt;dbl&gt;,
## #   SS6-R3 &lt;dbl&gt;, SS6-R4 &lt;dbl&gt;, SS6-R5 &lt;dbl&gt;, SS6-R6 &lt;dbl&gt;,
## #   SS6-R7 &lt;dbl&gt;</code></pre>
</div>
<div id="splitting-a-variable" class="section level2">
<h2><span class="header-section-number">16.3</span> Splitting a variable</h2>
<p>The <code>long_frames</code> data frame we created is close to what we need, but the <code>query</code> variable isn’t quite right. A value of <code>"SS2-R1"</code> corresponds to a trial on which the sample size was 2 and the test item was 1. This should properly be two variables, one specifying the <code>sample_size</code> and the other specifying the value of the <code>test_item</code>.</p>
<pre class="r"><code>long_frames %&gt;% 
  separate(
    col = query, 
    into = c(&quot;sample_size&quot;,&quot;test_item&quot;), 
    sep = &quot;-R&quot;
  )</code></pre>
<pre><code>## # A tibble: 4,725 x 7
##       ID Gender   Age Sampling sample_size test_item response
##    &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;chr&gt;    &lt;chr&gt;       &lt;chr&gt;        &lt;dbl&gt;
##  1     1 male      36 category SS2         1                8
##  2     2 male      46 category SS2         1                7
##  3     3 female    33 property SS2         1                8
##  4     4 female    71 property SS2         1                6
##  5     5 female    23 property SS2         1                9
##  6     6 female    31 category SS2         1                7
##  7     7 male      23 property SS2         1                6
##  8     8 female    31 property SS2         1                4
##  9     9 female    37 category SS2         1                9
## 10    10 female    46 category SS2         1                8
## # … with 4,715 more rows</code></pre>
<p>Getting closer. Note that there is a <code>unite()</code> function that reverses this operation, so if you ever need to collapse multiple columns into a single variable that would be the way to do it. It’s also worth noting that the two new variables aren’t quite in the format we want them to be. For instance, the <code>test_item</code> variable should be numeric rather than character, so lets <code>mutate</code> that and store the results:</p>
<pre class="r"><code>long_frames &lt;- long_frames %&gt;% 
  separate(
    col = query, 
    into = c(&quot;sample_size&quot;,&quot;test_item&quot;), 
    sep = &quot;-R&quot;
  ) %&gt;%
  mutate(test_item = as.numeric(test_item))
long_frames</code></pre>
<pre><code>## # A tibble: 4,725 x 7
##       ID Gender   Age Sampling sample_size test_item response
##    &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;chr&gt;    &lt;chr&gt;           &lt;dbl&gt;    &lt;dbl&gt;
##  1     1 male      36 category SS2                 1        8
##  2     2 male      46 category SS2                 1        7
##  3     3 female    33 property SS2                 1        8
##  4     4 female    71 property SS2                 1        6
##  5     5 female    23 property SS2                 1        9
##  6     6 female    31 category SS2                 1        7
##  7     7 male      23 property SS2                 1        6
##  8     8 female    31 property SS2                 1        4
##  9     9 female    37 category SS2                 1        9
## 10    10 female    46 category SS2                 1        8
## # … with 4,715 more rows</code></pre>
</div>
<div id="recoding-variables" class="section level2">
<h2><span class="header-section-number">16.4</span> Recoding variables</h2>
<div id="using-recode" class="section level3">
<h3><span class="header-section-number">16.4.1</span> Using <code>recode()</code></h3>
<p>What should we do with the <code>sample_size</code> variable?</p>
<pre class="r"><code>long_frames &lt;- long_frames %&gt;%
  mutate(sample_size = dplyr::recode(
    sample_size, 
    &quot;SS2&quot; = &quot;small&quot;, 
    &quot;SS6&quot; = &quot;medium&quot;, 
    &quot;SS12&quot; = &quot;large&quot;)
  )
long_frames</code></pre>
<pre><code>## # A tibble: 4,725 x 7
##       ID Gender   Age Sampling sample_size test_item response
##    &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;chr&gt;    &lt;chr&gt;           &lt;dbl&gt;    &lt;dbl&gt;
##  1     1 male      36 category small               1        8
##  2     2 male      46 category small               1        7
##  3     3 female    33 property small               1        8
##  4     4 female    71 property small               1        6
##  5     5 female    23 property small               1        9
##  6     6 female    31 category small               1        7
##  7     7 male      23 property small               1        6
##  8     8 female    31 property small               1        4
##  9     9 female    37 category small               1        9
## 10    10 female    46 category small               1        8
## # … with 4,715 more rows</code></pre>
</div>
<div id="using-case_when" class="section level3">
<h3><span class="header-section-number">16.4.2</span> Using <code>case_when()</code></h3>
<p>An alternative method is to use <code>case_when()</code>.</p>
<pre class="r"><code>long_frames &lt;- long_frames %&gt;%
  mutate(n_obs = case_when(
    sample_size == &quot;small&quot; ~ 2,
    sample_size == &quot;medium&quot; ~ 6,
    sample_size == &quot;large&quot; ~ 12
  ))
long_frames</code></pre>
<pre><code>## # A tibble: 4,725 x 8
##       ID Gender   Age Sampling sample_size test_item response
##    &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;chr&gt;    &lt;chr&gt;           &lt;dbl&gt;    &lt;dbl&gt;
##  1     1 male      36 category small               1        8
##  2     2 male      46 category small               1        7
##  3     3 female    33 property small               1        8
##  4     4 female    71 property small               1        6
##  5     5 female    23 property small               1        9
##  6     6 female    31 category small               1        7
##  7     7 male      23 property small               1        6
##  8     8 female    31 property small               1        4
##  9     9 female    37 category small               1        9
## 10    10 female    46 category small               1        8
## # … with 4,715 more rows, and 1 more variable: n_obs &lt;dbl&gt;</code></pre>
<p>Now we have a data frame that is almost identical to the one we imported in the previous section. Apart from some cosmetic changes to variable names and order, the job is complete!</p>
</div>
</div>
<div id="processing-dates" class="section level2">
<h2><span class="header-section-number">16.5</span> Processing dates</h2>
<p>Empirical data sets often include date fields. Sometimes these dates are nicely formatted and are easy to work with. Most of the time they are not. Even if they were, dates are inherently painful: a year isn’t a perfect multiple of days, so a solar calendar needs leap years and other corrections. The year doesn’t divide easily into 12 months so months have a variable number of days and doing “addition” with months is really weird. The week days don’t distribute themelves cleanly across months or years, so those are a headache too 🤕. It’s not purely an issue of nomenclature. We organise our lives around seasons, weekdays/weekends, day/night and various other cycles that don’t always play nicely with one another. The weirdness of dates reflects the structure of the world and our lives, and data analysts can’t pretend that this complexity isn’t there. To make things more annoying there are cultural and lingustic variations even within the English speaking world, so that is an additional source of ambiguity. Does 9/11 refer to September 11 or November 9? It depends on where you live. 🤷. Because of all this, date specification is hard. The <code>Date</code> class in R provides a relatively decent way to handle this kind of data, and the <strong>lubridate</strong> package (another tidyverse one!) provides a very helpful tool to make it easier. It doesn’t load automatically so lets do that now:</p>
<pre class="r"><code>library(lubridate)</code></pre>
<div id="getting-started" class="section level3">
<h3><span class="header-section-number">16.5.1</span> Getting started</h3>
<p>Date information is often specified in terms of “year”, “month” and “day”, though not always in that order. <strong>lubridate</strong> provides a collection of functions <code>ymd</code>, <code>mdy</code>, etc that are fairly smart and able to parse information in many different formats. As long as you know the order of the information, these functions work really well:</p>
<pre class="r"><code>ymd(20101215)
ymd(&quot;2010/12/15&quot;)
ymd(&quot;2010 December 15&quot;)</code></pre>
<pre><code>## [1] &quot;2010-12-15&quot;
## [1] &quot;2010-12-15&quot;
## [1] &quot;2010-12-15&quot;</code></pre>
<p>Despite the variations in formatting the function is able to work out that these all correspond to the same date and returns an variable of class <code>Date</code>. This gives you quite a bit of flexibility:</p>
<pre class="r"><code>ymd(20101215) == mdy(&quot;12/15/10&quot;)</code></pre>
<pre><code>## [1] TRUE</code></pre>
<p>Nice! The functions are smart enough to handle strings and numbers as input, and if the year is indeterminate it assumes a 21st century date. That said, they do rely on you knowing the correct order. The same numeric input, formatted differently…</p>
<pre class="r"><code>dmy(20101215)</code></pre>
<pre><code>## [1] &quot;1215-10-20&quot;</code></pre>
<p>… might indeed correspond to 20th October 1215. This might be plausible if the data set somehow pertained to the Magna Carta, but probably not for most settings of interest to psychologists!</p>
</div>
<div id="a-real-world-example" class="section level3">
<h3><span class="header-section-number">16.5.2</span> A real world example</h3>
<p>To give you a sense of how annoying working with dates can be, the following is a real example. I asked my partner – who in real life is a statistics consultant among other things – to send me a data set she’d been sent with poorly formatted date information. This is what she sent me:</p>
<pre class="r"><code>oddball &lt;- readLines(&quot;./data/oddballdate2.csv&quot;)
oddball</code></pre>
<pre><code>##  [1] &quot;4/4/16 9:00&quot;   &quot;4/4/16 14:13&quot;  &quot;6/4/16 5:55&quot;  
##  [4] &quot;6/4/16 11:27&quot;  &quot;8/4/16 15:04&quot;  &quot;12/4/16 12:29&quot;
##  [7] &quot;14/4/16 12:14&quot; &quot;14/4/16 19:16&quot; &quot;18/4/16 16:18&quot;
## [10] &quot;20/4/16 11:10&quot; &quot;28/4/16 16:10&quot; &quot;28/4/16&quot;      
## [13] &quot;1/5/16 17:11&quot;  &quot;2/5/16 14:53&quot;  &quot;3/5/16 10:32&quot; 
## [16] &quot;3/5/16 12:46&quot;  &quot;3/5/16 13:08&quot;  &quot;3/5/16 15:51&quot; 
## [19] &quot;4/5/16 11:04&quot;  &quot;4/5/16 11:13&quot;  &quot;4/5/16 11:16&quot; 
## [22] &quot;4/5/16 12:54&quot;  &quot;4/5/16 14:40&quot;  &quot;4/5/16 20:16&quot; 
## [25] &quot;6/5/16 15:13&quot;  &quot;10/5/16 11:17&quot; &quot;11/5/16 12:41&quot;
## [28] &quot;12/5/16&quot;       &quot;12/5/16&quot;       &quot;5/13/16&quot;      
## [31] &quot;16/5/16 10:11&quot; &quot;16/5/16 22:47&quot; &quot;17/5/16 15:20&quot;
## [34] &quot;18/5/16&quot;       &quot;18/5/16 10:32&quot; &quot;19/5/16 2:27&quot; 
## [37] &quot;19/5/16 10:59&quot; &quot;19/5/16&quot;</code></pre>
<p>To keep this example minimal, I’ve used <code>readLines()</code> to import the data as a single character vector. As you can see this pretty inconsistent, and my partner’s face when I turned to her in horror can only be described with emoji: 😈</p>
<p>A brief look at this suggests that <em>most</em> of the data have a time stamp as well as date information, which suggests that the <code>dmy_hm</code> function should be able to parse them. Others are date only, suggesting that <code>dmy</code> should work. If I try these individually this is what happens:</p>
<pre class="r"><code>dmy(oddball)</code></pre>
<pre><code>## Warning: 33 failed to parse.</code></pre>
<pre><code>##  [1] NA           NA           NA           NA          
##  [5] NA           NA           NA           NA          
##  [9] NA           NA           NA           &quot;2016-04-28&quot;
## [13] NA           NA           NA           NA          
## [17] NA           NA           NA           NA          
## [21] NA           NA           NA           NA          
## [25] NA           NA           NA           &quot;2016-05-12&quot;
## [29] &quot;2016-05-12&quot; NA           NA           NA          
## [33] NA           &quot;2016-05-18&quot; NA           NA          
## [37] NA           &quot;2016-05-19&quot;</code></pre>
<pre class="r"><code>dmy_hm(oddball)</code></pre>
<pre><code>## Warning: 6 failed to parse.</code></pre>
<pre><code>##  [1] &quot;2016-04-04 09:00:00 UTC&quot; &quot;2016-04-04 14:13:00 UTC&quot;
##  [3] &quot;2016-04-06 05:55:00 UTC&quot; &quot;2016-04-06 11:27:00 UTC&quot;
##  [5] &quot;2016-04-08 15:04:00 UTC&quot; &quot;2016-04-12 12:29:00 UTC&quot;
##  [7] &quot;2016-04-14 12:14:00 UTC&quot; &quot;2016-04-14 19:16:00 UTC&quot;
##  [9] &quot;2016-04-18 16:18:00 UTC&quot; &quot;2016-04-20 11:10:00 UTC&quot;
## [11] &quot;2016-04-28 16:10:00 UTC&quot; NA                       
## [13] &quot;2016-05-01 17:11:00 UTC&quot; &quot;2016-05-02 14:53:00 UTC&quot;
## [15] &quot;2016-05-03 10:32:00 UTC&quot; &quot;2016-05-03 12:46:00 UTC&quot;
## [17] &quot;2016-05-03 13:08:00 UTC&quot; &quot;2016-05-03 15:51:00 UTC&quot;
## [19] &quot;2016-05-04 11:04:00 UTC&quot; &quot;2016-05-04 11:13:00 UTC&quot;
## [21] &quot;2016-05-04 11:16:00 UTC&quot; &quot;2016-05-04 12:54:00 UTC&quot;
## [23] &quot;2016-05-04 14:40:00 UTC&quot; &quot;2016-05-04 20:16:00 UTC&quot;
## [25] &quot;2016-05-06 15:13:00 UTC&quot; &quot;2016-05-10 11:17:00 UTC&quot;
## [27] &quot;2016-05-11 12:41:00 UTC&quot; NA                       
## [29] NA                        NA                       
## [31] &quot;2016-05-16 10:11:00 UTC&quot; &quot;2016-05-16 22:47:00 UTC&quot;
## [33] &quot;2016-05-17 15:20:00 UTC&quot; NA                       
## [35] &quot;2016-05-18 10:32:00 UTC&quot; &quot;2016-05-19 02:27:00 UTC&quot;
## [37] &quot;2016-05-19 10:59:00 UTC&quot; NA</code></pre>
<p>Each function converts the dates it can, inserts <code>NA</code> for the dates it can’t, and loudly complain that something is amiss. That’s pretty reasonable.</p>
<pre class="r"><code>d1 &lt;- oddball %&gt;% dmy_hm() %&gt;% date()
d2 &lt;- oddball %&gt;% dmy() 
clean_dates &lt;- case_when(
  is.na(d1) ~ d2, 
  TRUE ~ d1
  )
clean_dates</code></pre>
<pre><code>##  [1] &quot;2016-04-04&quot; &quot;2016-04-04&quot; &quot;2016-04-06&quot; &quot;2016-04-06&quot;
##  [5] &quot;2016-04-08&quot; &quot;2016-04-12&quot; &quot;2016-04-14&quot; &quot;2016-04-14&quot;
##  [9] &quot;2016-04-18&quot; &quot;2016-04-20&quot; &quot;2016-04-28&quot; &quot;2016-04-28&quot;
## [13] &quot;2016-05-01&quot; &quot;2016-05-02&quot; &quot;2016-05-03&quot; &quot;2016-05-03&quot;
## [17] &quot;2016-05-03&quot; &quot;2016-05-03&quot; &quot;2016-05-04&quot; &quot;2016-05-04&quot;
## [21] &quot;2016-05-04&quot; &quot;2016-05-04&quot; &quot;2016-05-04&quot; &quot;2016-05-04&quot;
## [25] &quot;2016-05-06&quot; &quot;2016-05-10&quot; &quot;2016-05-11&quot; &quot;2016-05-12&quot;
## [29] &quot;2016-05-12&quot; NA           &quot;2016-05-16&quot; &quot;2016-05-16&quot;
## [33] &quot;2016-05-17&quot; &quot;2016-05-18&quot; &quot;2016-05-18&quot; &quot;2016-05-19&quot;
## [37] &quot;2016-05-19&quot; &quot;2016-05-19&quot;</code></pre>
<p>Well that <em>almost</em> worked. What’s the one <code>NA</code> value?</p>
<pre class="r"><code>oddball[is.na(clean_dates)]</code></pre>
<pre><code>## [1] &quot;5/13/16&quot;</code></pre>
<p>Sigh. Looking at all the other dates, every single one is in April or May… but this last one is ostensibly on the 5th day of the 13th month? Obviously we have <em>one</em> entry formatted in a <code>mdy()</code> form. I will leave it as an exercise to the reader to work out how to fix that one 😀</p>
</div>
</div>
<div id="combining-data-frames" class="section level2">
<h2><span class="header-section-number">16.6</span> Combining data frames</h2>
<p>Another common data manipulation problem arises when we need to combine multiple data frames. Two versions of this problem are worth talking about, namely <em>binding</em> and <em>joining</em></p>
<div id="binding" class="section level3">
<h3><span class="header-section-number">16.6.1</span> Binding</h3>
<p>Binding data frames is simple. Suppose we have multiple data frames that have the same variables, and we want to concatenate them. For instance, here are three small data frames:</p>
<pre class="r"><code>nightgarden_top &lt;- read_csv(&quot;./data/nightgarden_top.csv&quot;)
nightgarden_middle &lt;- read_csv(&quot;./data/nightgarden_middle.csv&quot;)
nightgarden_bottom &lt;- read_csv(&quot;./data/nightgarden_bottom.csv&quot;)</code></pre>
<p>Each of these contains a subset of the rows we need:</p>
<pre class="r"><code>nightgarden_middle</code></pre>
<pre><code>## # A tibble: 2 x 3
##    line speaker     utterance
##   &lt;dbl&gt; &lt;chr&gt;       &lt;chr&gt;    
## 1     6 tombliboo   oo       
## 2     7 makka-pakka pip</code></pre>
<p>We can use <code>dplyr::bind_rows()</code> to concatenate these data frames vertically:</p>
<pre class="r"><code>bind_rows(nightgarden_top, nightgarden_middle, nightgarden_bottom)</code></pre>
<pre><code>## # A tibble: 10 x 3
##     line speaker     utterance
##    &lt;dbl&gt; &lt;chr&gt;       &lt;chr&gt;    
##  1     1 upsy-daisy  pip      
##  2     2 upsy-daisy  pip      
##  3     3 upsy-daisy  onk      
##  4     4 upsy-daisy  onk      
##  5     5 tombliboo   ee       
##  6     6 tombliboo   oo       
##  7     7 makka-pakka pip      
##  8     8 makka-pakka pip      
##  9     9 makka-pakka onk      
## 10    10 makka-pakka onk</code></pre>
<p>There is an analogous function <code>dplyr::bind_columns()</code> that concatenates horizontally.</p>
</div>
<div id="joining" class="section level3">
<h3><span class="header-section-number">16.6.2</span> Joining</h3>
<p>More complicated situations arise when each data frame potentially contains information about the same cases and variables, but not necessarily all the same ones. A common situation in which this arises in real research is when participants complete two different tasks (e.g. a questionnaire and an experimental task) and the data are stored separately from each tasks. Ideally we might hope to have data from every participant for do both versions, but that does not always occur. As a toy example, suppose we collected some <code>demographics</code> for major characters from Terry Pratchett’s <em>Discworld</em> novels:</p>
<pre class="r"><code>demographics &lt;- read_csv(&quot;./data/discworld_demographics.csv&quot;)
demographics</code></pre>
<pre><code>## # A tibble: 4 x 3
##   id        gender residence   
##   &lt;chr&gt;     &lt;chr&gt;  &lt;chr&gt;       
## 1 rincewind male   ankh-morpork
## 2 vimes     male   ankh-morpork
## 3 granny    female lancre      
## 4 death     other  other</code></pre>
<p>Only some of the characters completed this questionnaire however. We might also have obtained <code>responses</code> from Discworld characters to some experimental task, and again we have partial data:</p>
<pre class="r"><code>responses &lt;- read_csv(&quot;./data/discworld_responses.csv&quot;)
responses</code></pre>
<pre><code>## # A tibble: 3 x 4
##   id     answer1 answer2 answer3
##   &lt;chr&gt;  &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;  
## 1 vimes  yes     no      no     
## 2 granny no      no      no     
## 3 brutha maybe   maybe   yes</code></pre>
<p>How should we <em>join</em> these two data frames together? In general there is no right or wrong answer to this question, merely different possibilities that will be of use in different situations:</p>
<ul>
<li>An inner join contains only those rows that appear in both data frames</li>
<li>A full join contains every row that appears in at least one data frame</li>
<li>A left join contains every row that appears in the first data frame</li>
<li>A right join contains every row that appears in the second data frame</li>
</ul>
<p>In order to work out which rows are matched in the different data frames, the default is to use any variable name that appears in both data sets (though this can be customised). For the <em>Discworld</em> data, the only two characters that appear in both the <code>demographics</code> data set and the <code>reponses</code> data are Vimes and Granny, so when we construct an inner join, we end up with a data frame that includes only those two characters:</p>
<pre class="r"><code>inner_join(demographics, responses)</code></pre>
<pre><code>## Joining, by = &quot;id&quot;</code></pre>
<pre><code>## # A tibble: 2 x 6
##   id     gender residence    answer1 answer2 answer3
##   &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;        &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;  
## 1 vimes  male   ankh-morpork yes     no      no     
## 2 granny female lancre       no      no      no</code></pre>
<p>By contrast, if we construct a full join, every character is included in the result, with <code>NA</code> values inserted for all the missing cases:</p>
<pre class="r"><code>full_join(demographics, responses)</code></pre>
<pre><code>## Joining, by = &quot;id&quot;</code></pre>
<pre><code>## # A tibble: 5 x 6
##   id        gender residence    answer1 answer2 answer3
##   &lt;chr&gt;     &lt;chr&gt;  &lt;chr&gt;        &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;  
## 1 rincewind male   ankh-morpork &lt;NA&gt;    &lt;NA&gt;    &lt;NA&gt;   
## 2 vimes     male   ankh-morpork yes     no      no     
## 3 granny    female lancre       no      no      no     
## 4 death     other  other        &lt;NA&gt;    &lt;NA&gt;    &lt;NA&gt;   
## 5 brutha    &lt;NA&gt;   &lt;NA&gt;         maybe   maybe   yes</code></pre>
<p>Suppose we want to retain data only for those characters that completed the <code>demographics</code> survey. A left join is what we need here:</p>
<pre class="r"><code>left_join(demographics, responses)</code></pre>
<pre><code>## Joining, by = &quot;id&quot;</code></pre>
<pre><code>## # A tibble: 4 x 6
##   id        gender residence    answer1 answer2 answer3
##   &lt;chr&gt;     &lt;chr&gt;  &lt;chr&gt;        &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;  
## 1 rincewind male   ankh-morpork &lt;NA&gt;    &lt;NA&gt;    &lt;NA&gt;   
## 2 vimes     male   ankh-morpork yes     no      no     
## 3 granny    female lancre       no      no      no     
## 4 death     other  other        &lt;NA&gt;    &lt;NA&gt;    &lt;NA&gt;</code></pre>
<p>By analogy, if we wanted to retain data only for those characters that provided <code>responses</code>, we would use the <code>right_join()</code> function. It’s also worth noting that there also <code>semi_join()</code> and <code>anti_join()</code> functions that can handle other kinds of situations, but I won’t go into those here.</p>
</div>
</div>
<div id="more-resources" class="section level2">
<h2><span class="header-section-number">16.7</span> More resources</h2>
<ul>
<li>For a discussion of <a href="https://data.library.virginia.edu/working-with-dates-and-time-in-r-using-the-lubridate-package/">dates using lubridate</a></li>
</ul>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
